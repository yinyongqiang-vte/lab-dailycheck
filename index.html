<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥è·³è½¬</title>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; }
        .status-success { background-color: #e6f4ea; color: #137333; }
        .status-error { background-color: #fce8e6; color: #c5221f; }
        .btn { background-color: #1a73e8; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 20px; font-size: 16px; display: none; }
        .loading { color: #1a73e8; margin-top: 10px; font-size: 0.9em; display:none;}
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>
    <div id="jumpMsg" class="loading">æ­£åœ¨è·³è½¬è‡³æ£€æŸ¥è¡¨å•...</div>
    <button id="scanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“ (å·²åŒ…å«æ‚¨çš„çœŸå®æ•°æ®)
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. âš ï¸ è¡¨å•è·³è½¬é…ç½® (è¯·ä¿®æ”¹è¿™é‡Œï¼)
    // ==========================================
    const FORM_CONFIG = {
        // [A] æ‚¨çš„å¤šç»´è¡¨æ ¼æ”¶é›†é“¾æ¥ (ä¸å¸¦å‚æ•°çš„åŸºç¡€é“¾æ¥)
        // ç¤ºä¾‹: "https://doc.weixin.qq.com/form/collect/DjkA..."
        url: "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3", 

        // [B] è¡¨æ ¼ä¸­å„å­—æ®µå¯¹åº”çš„â€œå‚æ•°å/IDâ€
        // æ‚¨éœ€è¦å»ä¼ä¸šå¾®ä¿¡/è…¾è®¯æ–‡æ¡£çš„â€œé¢„å¡«å……â€è®¾ç½®é‡ŒæŸ¥æ‰¾è¿™äº› key
        keys: {
            id:      "field_xxx",  // å¯¹åº”è¡¨æ ¼é‡Œçš„ [å®éªŒå®¤ID] åˆ—
            name:    "field_yyy",  // å¯¹åº”è¡¨æ ¼é‡Œçš„ [å®éªŒå®¤åç§°] åˆ—
            officer: "field_zzz"   // å¯¹åº”è¡¨æ ¼é‡Œçš„ [å®‰å…¨å‘˜] åˆ—
        }
    };

    // ==========================================
    // 3. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const jumpMsg = document.getElementById('jumpMsg');
    const scanBtn = document.getElementById('scanBtn');

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            verifyAndJump(urlLabId);
        } else {
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ");
                scanBtn.style.display = "block";
            } else {
                updateStatus("âš ï¸ æœªæ£€æµ‹åˆ°NFCå‚æ•°ï¼Œè¯·è´´è¿‘æ ‡ç­¾ã€‚", "status-error");
            }
        }
    };

    function verifyAndJump(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆçš„å®éªŒå®¤ ID (${id})`, "status-error");
            return;
        }

        // éªŒè¯é€šè¿‡
        updateStatus(`âœ… éªŒè¯é€šè¿‡ï¼š${labData.name}`, "status-success");
        scanBtn.style.display = "none";
        jumpMsg.style.display = "block";

        // --- æ„å»ºè·³è½¬ URL ---
        // è‡ªåŠ¨å°†ä¸­æ–‡è¿›è¡Œç¼–ç ï¼Œé˜²æ­¢ä¹±ç 
        const finalUrl = `${FORM_CONFIG.url}?${FORM_CONFIG.keys.id}=${encodeURIComponent(labData.id)}&${FORM_CONFIG.keys.name}=${encodeURIComponent(labData.name)}&${FORM_CONFIG.keys.officer}=${encodeURIComponent(labData.officer)}`;

        // è°ƒè¯•æ‰“å° (æµ‹è¯•æ—¶å¯çœ‹æ§åˆ¶å°)
        console.log("å³å°†è·³è½¬åˆ°:", finalUrl);

        // å»¶è¿Ÿ 1 ç§’åè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹æ¸…éªŒè¯é€šè¿‡çš„æç¤º
        setTimeout(() => {
            window.location.href = finalUrl;
        }, 1000);
    }

    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·è´´è¿‘ NFC æ ‡ç­¾...");
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    // è§£æ lab_id
                    if (text.includes("lab_id=")) {
                        verifyAndJump(text.split("lab_id=")[1].split("&")[0]);
                        return;
                    } else if (record.recordType === "text" && !text.includes("http")) {
                         verifyAndJump(text);
                         return;
                    }
                }
            };
        } catch (error) {
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>

