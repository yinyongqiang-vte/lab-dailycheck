<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥ - èº«ä»½éªŒè¯</title>
    <style>
        /* ================= æ ·å¼åŒºåŸŸ ================= */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f2f4f7;
            color: #333;
        }
        
        .container {
            background: white;
            padding: 30px 25px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            max-width: 400px;
            margin: 0 auto;
        }

        h2 { margin-bottom: 5px; color: #1a73e8; letter-spacing: 1px; }
        .subtitle { font-size: 0.9em; color: #666; margin-bottom: 20px; }

        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 50px;
            font-size: 0.85em;
            margin-bottom: 25px;
            font-weight: 600;
        }

        /* å®éªŒå®¤ä¿¡æ¯å¡ç‰‡ */
        .info-card {
            background: #f8f9fa;
            border-left: 5px solid #1a73e8;
            padding: 20px;
            text-align: left;
            margin-bottom: 25px;
            border-radius: 8px;
            display: none; /* é»˜è®¤éšè— */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .info-card p { margin: 10px 0; font-size: 1.1rem; line-height: 1.5; }
        .label { color: #5f6368; font-size: 0.9em; display: inline-block; width: 70px; }

        /* çŠ¶æ€æç¤ºæ¡† */
        .status-box {
            padding: 15px;
            border-radius: 10px;
            background-color: #e9ecef;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            display: none; /* é»˜è®¤éšè— */
            transition: background 0.2s;
        }
        .btn:active { background-color: #1669bb; transform: scale(0.98); }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    <div class="subtitle">å®éªŒå®¤å®‰å…¨ç®¡ç†ç³»ç»Ÿ</div>
    
    <div id="modeBadge" class="badge">æ£€æµ‹ç¯å¢ƒ...</div>

    <div id="labInfoCard" class="info-card">
        <p><span class="label">ğŸ“ åœ°ç‚¹</span> <strong><span id="labName">--</span></strong></p>
        <p><span class="label">ğŸ‘¤ å®‰å…¨å‘˜</span> <strong><span id="labOfficer">--</span></strong></p>
    </div>

    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>

    <button id="androidScanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“ (å·²å¡«å…¥ Excel æ–‡ä»¶ä¸­çš„çœŸå®æ•°æ®)
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. é¡µé¢é€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const labInfoCard = document.getElementById('labInfoCard');
    const scanBtn = document.getElementById('androidScanBtn');
    const modeBadge = document.getElementById('modeBadge');

    window.onload = function() {
        // å°è¯•ä» URL å‚æ•°ä¸­è·å– ID (iOS/é€šç”¨æ¨¡å¼)
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            // æ¨¡å¼ A: è‡ªåŠ¨è¯†åˆ«
            modeBadge.innerText = "è‡ªåŠ¨éªŒè¯æ¨¡å¼";
            verifyLab(urlLabId);
        } else {
            // æ¨¡å¼ B: æ‰‹åŠ¨æ‰«æ
            modeBadge.innerText = "æ‰‹åŠ¨æ‰«ææ¨¡å¼";
            
            // åªæœ‰æ”¯æŒ Web NFC çš„æµè§ˆå™¨ (Android Chrome) æ‰æ˜¾ç¤ºæŒ‰é’®
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ NFC æ ‡ç­¾");
                scanBtn.style.display = "block";
            } else {
                updateStatus("âš ï¸ æœªæ£€æµ‹åˆ°æ ‡ç­¾å‚æ•°ã€‚<br>è¯·ç›´æ¥ç”¨æ‰‹æœºè´´è¿‘å¢™ä¸Šçš„ NFC æ ‡ç­¾ã€‚", "status-error");
            }
        }
    };

    // éªŒè¯æ ¸å¿ƒé€»è¾‘
    function verifyLab(id) {
        // åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ éªŒè¯å¤±è´¥ï¼šæ— æ•ˆçš„å®éªŒå®¤ ID (${id})`, "status-error");
            return;
        }

        // --- éªŒè¯é€šè¿‡ ---
        
        // å¡«å……ä¿¡æ¯
        document.getElementById('labName').innerText = labData.name;
        document.getElementById('labOfficer').innerText = labData.officer;
        
        // æ˜¾ç¤ºç•Œé¢å…ƒç´ 
        labInfoCard.style.display = "block";
        scanBtn.style.display = "none"; // éšè—æŒ‰é’®

        // æ›´æ–°çŠ¶æ€
        updateStatus("âœ… éªŒè¯é€šè¿‡ï¼<br>è¯·å¼€å§‹è¿›è¡Œå®‰å…¨æ£€æŸ¥", "status-success");
        
        // (å¯é€‰) 2ç§’åè‡ªåŠ¨è·³è½¬åˆ°æ£€æŸ¥è¡¨å•
        // setTimeout(() => { window.location.href = "check_list.html?lab=" + id; }, 2000);
    }

    // Android æ‰‹åŠ¨æ‰«ææŒ‰é’®é€»è¾‘
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...");

            ndef.onreading = event => {
                const decoder = new TextDecoder();
                let scannedId = null;

                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    
                    // 1. å°è¯•è§£æ URL é‡Œçš„ lab_id
                    if (text.includes("lab_id=")) {
                        scannedId = text.split("lab_id=")[1].split("&")[0];
                        break;
                    } 
                    // 2. å°è¯•è§£æçº¯æ–‡æœ¬ ID
                    else if (record.recordType === "text" && !text.includes("http")) {
                        scannedId = text;
                        break;
                    }
                }

                if (scannedId) verifyLab(scannedId);
                else updateStatus("æ— æ³•è¯†åˆ«æ ‡ç­¾æ•°æ®ï¼Œè¯·é‡è¯•", "status-error");
            };
        } catch (error) {
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥: " + error.message, "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>

</body>
</html>
