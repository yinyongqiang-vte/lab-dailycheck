<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨å·¡æ£€è·³è½¬</title>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; word-break: break-all; font-size: 14px;}
        .status-success { background-color: #e6f4ea; color: #137333; }
        .status-error { background-color: #fce8e6; color: #c5221f; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { background-color: #1a73e8; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 20px; font-size: 16px; cursor: pointer; }
        .btn-manual { background-color: #008000; display: none; margin-top: 15px; } /* ç»¿è‰²æ‰‹åŠ¨æŒ‰é’®ï¼Œé»˜è®¤éšè— */
        
        .loading { color: #1a73e8; margin-top: 10px; font-size: 0.9em; display:none;}
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>
    <div id="jumpMsg" class="loading">æ­£åœ¨æ‰“å¼€...</div>

    <button id="scanBtn" class="btn" style="display:none;">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>

    <a id="manualLink" href="#" target="_self" style="text-decoration:none;">
        <button id="manualBtn" class="btn btn-manual">ğŸ‘‰ ç‚¹æ­¤ç›´æ¥æ‰“å¼€è¡¨æ ¼</button>
    </a>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006" }
    ];

    // ==========================================
    // 2. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const jumpMsg = document.getElementById('jumpMsg');
    const scanBtn = document.getElementById('scanBtn');
    const manualBtn = document.getElementById('manualBtn');
    const manualLink = document.getElementById('manualLink');

    // ç›®æ ‡é“¾æ¥ (ç¡¬ç¼–ç åœ¨è¿™é‡Œï¼Œç¡®ä¿ç»å¯¹æ­£ç¡®)
    const TARGET_URL = "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            handleCheck(urlLabId);
        } else {
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ");
                scanBtn.style.display = "block";
            } else {
                updateStatus("âš ï¸ æœªæ£€æµ‹åˆ°NFCç¯å¢ƒ (è¯·ç¡®ä¿åœ¨httpsä¸‹è¿è¡Œ)", "status-error");
            }
        }
    };

    function handleCheck(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆ ID: ${id}`, "status-error");
            return;
        }

        // 1. ç•Œé¢æ›´æ–°
        updateStatus(`âœ… ${labData.name} éªŒè¯é€šè¿‡`, "status-success");
        scanBtn.style.display = "none";
        jumpMsg.style.display = "block";

        // 2. å‡†å¤‡é“¾æ¥ (å»é™¤æ‰€æœ‰ç©ºæ ¼ï¼Œé˜²æ­¢æ±¡æŸ“)
        const cleanUrl = TARGET_URL.replace(/\s+/g, '');

        // 3. æ¿€æ´»æ‰‹åŠ¨æŒ‰é’® (ä½œä¸ºåŒä¿é™©)
        manualLink.href = cleanUrl;
        manualBtn.style.display = "block";
        manualBtn.innerText = `ğŸ‘‰ æ‰“å¼€: ${labData.name} è¡¨æ ¼`;

        // 4. å°è¯•ã€æ¨¡æ‹Ÿç‚¹å‡»ã€‘è·³è½¬ (æ¯” window.location æ›´ç¨³å®š)
        console.log("å°è¯•æ¨¡æ‹Ÿç‚¹å‡»è·³è½¬:", cleanUrl);
        
        setTimeout(() => {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ a æ ‡ç­¾æ¥ç‚¹å‡»
            const link = document.createElement('a');
            link.href = cleanUrl;
            link.target = "_self"; // åœ¨å½“å‰é¡µæ‰“å¼€ï¼Œé˜²æ­¢æ‹¦æˆª
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, 800);
    }

    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·è´´è¿‘ NFC æ ‡ç­¾...");
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    // ç®€å•çš„è§£æé€»è¾‘
                    if (text.includes("lab_id=")) {
                        handleCheck(text.split("lab_id=")[1].split("&")[0]);
                    } else if (record.recordType === "text" && !text.includes("http")) {
                        handleCheck(text);
                    }
                }
            };
        } catch (error) {
            console.error(error);
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥: " + error, "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
