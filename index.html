<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥</title>
    <style>
        /* --- ä¿æŒæ‚¨åŸæ¥çš„æ ·å¼ä¸åŠ¨ï¼Œä»…å¾®è°ƒ --- */
        body { font-family: -apple-system, Helvetica, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; word-break: break-all; }
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        
        .btn { border: none; padding: 16px; border-radius: 12px; width: 100%; margin-top: 25px; font-size: 17px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        
        .btn-scan { background-color: #1a73e8; color: white; }
        .btn-go { background-color: #059669; color: white; display: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        
        /* æ–°å¢ï¼šåº•éƒ¨é€€å‡ºæŒ‰é’®æ ·å¼ï¼ˆç°è‰²ã€ä½è°ƒï¼‰ */
        .btn-exit { background-color: transparent; color: #888; border: 1px solid #ddd; margin-top: 15px; font-size: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    
    <div id="status" class="status-box">ğŸ‘‹ è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</div>

    <button id="scanBtn" class="btn btn-scan">ğŸ“¡ ç‚¹å‡»å¼€å§‹ NFC æ‰«æ</button>

    <button id="goBtn" class="btn btn-go" onclick="jumpToForm()">âœ… éªŒè¯é€šè¿‡<br><span style="font-size:0.9em; font-weight:normal">ç‚¹å‡»å¡«å†™æ£€æŸ¥è¡¨</span></button>
    
    <button onclick="closeWindow()" class="btn btn-exit">é€€å‡ºç³»ç»Ÿ</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“ (ä¿æŒåŸæ ·)
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. ç›®æ ‡é“¾æ¥é…ç½®
    // ==========================================
    const RAW_URL = "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3";

    // ==========================================
    // 3. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const scanBtn = document.getElementById('scanBtn');
    const goBtn = document.getElementById('goBtn');
    
    // å…¨å±€å˜é‡å­˜å‚¨å¤„ç†åçš„é“¾æ¥
    let targetUrl = "";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');
        if (urlLabId) verifyAndShowButton(urlLabId);
        
        if (!("NDEFReader" in window)) {
            console.log("NFC not supported");
        }
    };

    function verifyAndShowButton(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆçš„å®éªŒå®¤ ID: ${id}`, "status-error");
            return;
        }

        // 1. æ›´æ–°æç¤º
        updateStatus(`âœ… å·²è¯†åˆ«ï¼š${labData.name}<br><span style="font-weight:normal; font-size:0.9em; color:#137333">å®‰å…¨å‘˜ï¼š${labData.officer}</span>`, "status-success");
        
        // 2. åˆ‡æ¢æŒ‰é’®
        scanBtn.style.display = "none";
        goBtn.style.display = "block";

        // 3. å‡†å¤‡é“¾æ¥
        targetUrl = RAW_URL.replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
    }

    // ==========================================
    // æ–°å¢ä¼˜åŒ–åŠŸèƒ½ï¼šè·³è½¬ä¸é€€å‡º
    // ==========================================

    // åŠŸèƒ½1ï¼šè·³è½¬åˆ°è¡¨æ ¼
    function jumpToForm() {
        if (!targetUrl) return;
        
        // ä½¿ç”¨ replace è€Œä¸æ˜¯ hrefï¼Œè¿™æ ·åœ¨è¡¨æ ¼é¡µé¢æŒ‰â€œè¿”å›â€æ—¶ï¼Œ
        // ä¸ä¼šå†å›åˆ°è¿™ä¸ªæ‰«æé¡µï¼Œè€Œæ˜¯ç›´æ¥é€€å‡ºï¼Œè¾¾åˆ°â€œå¡«å†™å®Œå³é€€å‡ºâ€çš„æ•ˆæœ
        window.location.replace(targetUrl);
    }

    // åŠŸèƒ½2ï¼šå…³é—­å½“å‰çª—å£ (é€‚é…ä¼ä¸šå¾®ä¿¡/å¾®ä¿¡)
    function closeWindow() {
        // å°è¯•è°ƒç”¨å¾®ä¿¡åŸç”Ÿå…³é—­èƒ½åŠ›
        if (typeof WeixinJSBridge !== "undefined") {
            WeixinJSBridge.call('closeWindow');
        } else {
            // æ™®é€šæµè§ˆå™¨å…œåº•
            window.close();
            updateStatus("è¯·æ‰‹åŠ¨å…³é—­æ­¤çª—å£");
        }
    }

    // ==========================================
    // NFC æ‰«æé€»è¾‘ (ä¿æŒæ‚¨åŸä»£ç é€»è¾‘)
    // ==========================================
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("ğŸ“² è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...");
            
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    
                    if (text.includes("lab_id=")) {
                        verifyAndShowButton(text.split("lab_id=")[1].split("&")[0]);
                    } else if (record.recordType === "text" && !text.includes("http")) {
                        verifyAndShowButton(text);
                    }
                }
            };
        } catch (error) {
            console.error(error);
            updateStatus("âŒ æ‰«æå¯åŠ¨å¤±è´¥ (è¯·ç¡®è®¤å¼€å¯NFCæˆ–ä½¿ç”¨HTTPS)", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
