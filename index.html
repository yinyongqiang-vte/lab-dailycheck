<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥å…¥å£</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 400px;
            margin: 0 auto;
        }
        h2 { margin-bottom: 10px; color: #1a73e8; }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            text-align: left;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none; /* é»˜è®¤éšè—ï¼Œè¯†åˆ«æˆåŠŸåæ˜¾ç¤º */
        }
        .info-card p { margin: 5px 0; font-size: 0.95em; }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            background-color: #e9ecef;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px;
            flex-direction: column;
            gap: 5px;
        }
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
            transition: background 0.2s;
            display: none; /* é»˜è®¤éšè— */
        }
        .btn:active { transform: scale(0.98); }
        .btn-retry { background-color: #5f6368; margin-top: 10px; }
        
        /* çŠ¶æ€é¢œè‰² */
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        .status-loading { background-color: #e8f0fe; color: #1a73e8; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®éªŒå®¤å®‰å…¨å«å£«</h2>
    <div id="modeBadge" class="badge">æ­£åœ¨æ£€æµ‹è¿è¡Œæ¨¡å¼...</div>

    <div id="labInfoCard" class="info-card">
        <p><strong>ğŸ“ å®éªŒå®¤ï¼š</strong> <span id="labName">--</span></p>
        <p><strong>ğŸ‘¤ å®‰å…¨å‘˜ï¼š</strong> <span id="labOfficer">--</span></p>
        <p><strong>ğŸ†” IDï¼š</strong> <span id="labIdDisplay">--</span></p>
    </div>

    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>

    <button id="androidScanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ (Android)</button>
    <button id="retryLocBtn" class="btn btn-retry">ğŸ“ é‡æ–°è·å–ä½ç½®</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“é…ç½®
    // ==========================================
    const LAB_DATABASE = [
        {
            id: "test1", 
            name: "æµ‹è¯•æˆ¿é—´", 
            officer: "æµ‹è¯•äºº1",
            // âš ï¸ è¯·åŠ¡å¿…ä¿®æ”¹ä»¥ä¸‹ç»çº¬åº¦ä¸ºå®éªŒå®¤çš„çœŸå®åæ ‡ï¼
            // å¦åˆ™æ— æ³•é€šè¿‡ä½ç½®éªŒè¯ (ç›®å‰å¡«çš„æ˜¯ç¤ºä¾‹åæ ‡)
            lat: 39.904200, 
            lng: 116.407400 
        }
    ];

    const MAX_DISTANCE_METERS = 100; // å…è®¸çš„è¯¯å·®èŒƒå›´ (ç±³)

    // ==========================================
    // 2. é¡µé¢é€»è¾‘æ§åˆ¶
    // ==========================================
    const statusDiv = document.getElementById('status');
    const labInfoCard = document.getElementById('labInfoCard');
    const scanBtn = document.getElementById('androidScanBtn');
    const retryBtn = document.getElementById('retryLocBtn');
    const modeBadge = document.getElementById('modeBadge');

    // é¡µé¢åŠ è½½å®Œæ¯•åï¼Œç«‹å³åˆ¤æ–­è¿›å…¥æ–¹å¼
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            // [æ¨¡å¼ A]ï¼šé€šè¿‡ NFC æ ‡ç­¾é‡Œçš„ URL è·³è½¬è¿›æ¥ (iOS/Androidé€šç”¨)
            modeBadge.innerText = "æ¨¡å¼ï¼šNFC è‡ªåŠ¨è¯†åˆ«";
            handleLabIdentification(urlLabId);
        } else {
            // [æ¨¡å¼ B]ï¼šç”¨æˆ·ç›´æ¥æ‰“å¼€ç½‘é¡µ (éœ€è¦æ‰‹åŠ¨æ‰«æ)
            modeBadge.innerText = "æ¨¡å¼ï¼šæ‰‹åŠ¨æ‰«æ";
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ NFC æ ‡ç­¾");
                scanBtn.style.display = "block"; // æ˜¾ç¤ºæ‰«ææŒ‰é’®
            } else {
                updateStatus("æœªæ£€æµ‹åˆ° NFC å‚æ•°ï¼Œä¸”æµè§ˆå™¨ä¸æ”¯æŒ Web NFCã€‚<br>è¯·æ£€æŸ¥æ˜¯å¦é€šè¿‡ NFC æ ‡ç­¾è·³è½¬ã€‚", "status-error");
            }
        }
    };

    // ==========================================
    // 3. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°
    // ==========================================

    // å¤„ç†è¯†åˆ«åˆ°çš„å®éªŒå®¤ ID
    function handleLabIdentification(id) {
        // 1. åœ¨æ•°æ®åº“ä¸­æŸ¥æ‰¾
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ é”™è¯¯ï¼šæ•°æ®åº“ä¸­æ‰¾ä¸åˆ° ID ä¸º "${id}" çš„å®éªŒå®¤ã€‚`, "status-error");
            return;
        }

        // 2. æ˜¾ç¤ºå®éªŒå®¤ä¿¡æ¯
        document.getElementById('labName').innerText = labData.name;
        document.getElementById('labOfficer').innerText = labData.officer;
        document.getElementById('labIdDisplay').innerText = labData.id;
        labInfoCard.style.display = "block";
        scanBtn.style.display = "none"; // éšè—æ‰«ææŒ‰é’®

        // 3. å¼€å§‹ä½ç½®éªŒè¯
        verifyLocation(labData);
    }

    // éªŒè¯åœ°ç†ä½ç½®
    function verifyLocation(targetLab) {
        updateStatus("æ­£åœ¨è·å–æ‚¨çš„åœ°ç†ä½ç½®...", "status-loading");
        retryBtn.style.display = "none";

        if (!navigator.geolocation) {
            updateStatus("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®æœåŠ¡", "status-error");
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                // è®¡ç®—è·ç¦»
                const distance = calculateDistance(userLat, userLng, targetLab.lat, targetLab.lng);
                
                console.log(`ç”¨æˆ·åæ ‡: ${userLat}, ${userLng} | è·ç¦»ç›®æ ‡: ${distance}ç±³`);

                if (distance <= MAX_DISTANCE_METERS) {
                    // --- éªŒè¯æˆåŠŸ ---
                    updateStatus(`âœ… éªŒè¯é€šè¿‡ï¼<br>è·ç¦»è¯¯å·® ${Math.round(distance)} ç±³<br>æ­£åœ¨è·³è½¬è‡³æ£€æŸ¥è¡¨...`, "status-success");
                    
                    // 2ç§’åè·³è½¬ (æ­¤å¤„ä»…ä¸ºæ¼”ç¤º)
                    // setTimeout(() => { window.location.href = "check_form.html?lab=" + targetLab.id; }, 2000);
                } else {
                    // --- éªŒè¯å¤±è´¥ (è·ç¦»å¤ªè¿œ) ---
                    updateStatus(`âŒ ä½ç½®éªŒè¯å¤±è´¥<br>æ‚¨è·ç¦»å®éªŒå®¤ ${Math.round(distance)} ç±³<br>(å…è®¸è¯¯å·®: ${MAX_DISTANCE_METERS}ç±³)`, "status-error");
                    retryBtn.style.display = "block"; // å…è®¸é‡è¯•
                    
                    // ç»‘å®šé‡è¯•æŒ‰é’®äº‹ä»¶
                    retryBtn.onclick = () => verifyLocation(targetLab);
                }
            },
            (error) => {
                let errorMsg = "è·å–ä½ç½®å¤±è´¥";
                switch(error.code) {
                    case error.PERMISSION_DENIED: errorMsg = "è¯·å…è®¸æµè§ˆå™¨è·å–ä½ç½®æƒé™"; break;
                    case error.POSITION_UNAVAILABLE: errorMsg = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨"; break;
                    case error.TIMEOUT: errorMsg = "è·å–ä½ç½®è¶…æ—¶"; break;
                }
                updateStatus(`âŒ ${errorMsg}`, "status-error");
                retryBtn.style.display = "block";
                retryBtn.onclick = () => verifyLocation(targetLab);
            },
            { enableHighAccuracy: true, timeout: 8000 }
        );
    }

    // [Android] æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ‰«æé€»è¾‘
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...", "status-loading");

            ndef.onreading = event => {
                // è§£æé€»è¾‘ï¼šå°è¯•ä» URL æˆ– æ–‡æœ¬è®°å½•ä¸­æå– ID
                const decoder = new TextDecoder();
                let scannedId = null;

                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    // 1. å¦‚æœæ˜¯ URL è®°å½• (ä¾‹å¦‚ https://.../index.html?lab_id=test1)
                    if (text.includes("lab_id=")) {
                        scannedId = text.split("lab_id=")[1].split("&")[0]; // æå–å‚æ•°å€¼
                        break;
                    } 
                    // 2. å¦‚æœæ˜¯çº¯æ–‡æœ¬è®°å½• (å…¼å®¹æ—§æ ‡ç­¾)
                    else if (record.recordType === "text" && !text.includes("http")) {
                        scannedId = text;
                        break;
                    }
                }

                if (scannedId) {
                    handleLabIdentification(scannedId);
                } else {
                    updateStatus("æœªèƒ½è¯†åˆ«æœ‰æ•ˆçš„å®éªŒå®¤ IDä¿¡æ¯", "status-error");
                }
            };
        } catch (error) {
            updateStatus("NFC å¯åŠ¨å¤±è´¥: " + error.message, "status-error");
        }
    });

    // è¾…åŠ©å‡½æ•°ï¼šHaversine è·ç¦»è®¡ç®— (è¿”å›ç±³)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        if ((lat1 == lat2) && (lon1 == lon2)) return 0;
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180; 
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        const d = R * c;
        return d * 1000;
    }

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>

</body>
</html>