<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥è·³è½¬</title>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; }
        .status-success { background-color: #e6f4ea; color: #137333; }
        .status-error { background-color: #fce8e6; color: #c5221f; }
        .btn { background-color: #1a73e8; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 20px; font-size: 16px; display: none; }
        .loading { color: #1a73e8; margin-top: 10px; font-size: 0.9em; display:none;}
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>
    <div id="jumpMsg" class="loading">æ­£åœ¨è·³è½¬è‡³æ£€æŸ¥è¡¨å•...</div>
    <button id="scanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. è¡¨å•é…ç½® (å·²ç§»é™¤å¤æ‚çš„ Keys é…ç½®)
    // ==========================================
    const FORM_CONFIG = {
        // è¯·ç¡®ä¿è¿™é‡Œæ˜¯æ‚¨çš„æ”¶é›†è¡¨é“¾æ¥
        url: "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3"
    };

    // ==========================================
    // 3. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const jumpMsg = document.getElementById('jumpMsg');
    const scanBtn = document.getElementById('scanBtn');

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            verifyAndJump(urlLabId);
        } else {
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ");
                scanBtn.style.display = "block";
            } else {
                updateStatus("âš ï¸ æœªæ£€æµ‹åˆ°NFCå‚æ•°ï¼Œè¯·è´´è¿‘æ ‡ç­¾ã€‚", "status-error");
            }
        }
    };

    function verifyAndJump(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆçš„å®éªŒå®¤ ID (${id})`, "status-error");
            return;
        }

        // éªŒè¯é€šè¿‡
        updateStatus(`âœ… éªŒè¯é€šè¿‡ï¼š${labData.name}`, "status-success");
        scanBtn.style.display = "none";
        jumpMsg.style.display = "block";

        // ============================================
        // ä¿®æ”¹ç‚¹ï¼šç›´æ¥ä½¿ç”¨æ¸…æ´—åçš„åŸºç¡€é“¾æ¥ï¼Œä¸æ‹¼æ¥å‚æ•°
        // ============================================
        try {
            // 1. æ¸…ç†é“¾æ¥ä¸­çš„éšå½¢å­—ç¬¦å’Œç©ºæ ¼ (è§£å†³æ–‡ä»¶ä¸å­˜åœ¨é—®é¢˜)
            let cleanBaseUrl = FORM_CONFIG.url.replace(/[\u200B-\u200D\uFEFF\s]/g, '').trim();

            console.log("å³å°†è·³è½¬è‡³çº¯è¡¨å•:", cleanBaseUrl);

            // 2. å»¶è¿Ÿè·³è½¬
            setTimeout(() => {
                window.location.href = cleanBaseUrl;
            }, 1000);

        } catch (e) {
            updateStatus("é“¾æ¥é…ç½®æœ‰è¯¯", "status-error");
        }
    }

    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·è´´è¿‘ NFC æ ‡ç­¾...");
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    if (text.includes("lab_id=")) {
                        verifyAndJump(text.split("lab_id=")[1].split("&")[0]);
                        return;
                    } else if (record.recordType === "text" && !text.includes("http")) {
                         verifyAndJump(text);
                         return;
                    }
                }
            };
        } catch (error) {
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
