<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥</title>
    <style>
        body { 
            font-family: -apple-system, Helvetica, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: #f2f4f7; 
            height: 100vh;
            box-sizing: border-box;
        }
        .container { 
            background: white; 
            padding: 30px 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            max-width: 400px; 
            margin: 0 auto; 
        }
        
        /* çŠ¶æ€æç¤ºæ¡† */
        .status-box { 
            padding: 15px; 
            border-radius: 10px; 
            background-color: #e9ecef; 
            margin-top: 20px; 
            font-weight: bold; 
            color: #555; 
            word-break: break-all; 
            font-size: 15px;
        }
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn { 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            width: 100%; 
            margin-top: 20px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer; 
            display: block;
        }
        .btn:active { opacity: 0.8; }
        
        .btn-scan { background-color: #1a73e8; color: white; }
        
        /* éªŒè¯é€šè¿‡æŒ‰é’® */
        .btn-go { 
            background-color: #059669; 
            color: white; 
            display: none; /* é»˜è®¤éšè— */
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); 
        }

        /* é€€å‡ºæŒ‰é’® */
        .btn-exit { 
            background-color: transparent; 
            color: #999; 
            border: 1px solid #e0e0e0; 
            font-weight: normal; 
            font-size: 14px; 
            margin-top: 30px;
        }

        /* ç”¨äºè°ƒè¯•æ˜¾ç¤ºçš„é“¾æ¥ï¼ˆé»˜è®¤éšè—ï¼Œå‡ºé”™æ—¶å¯æ’æŸ¥ï¼‰ */
        #debug-url {
            font-size: 10px;
            color: #ccc;
            margin-top: 10px;
            word-break: break-all;
            display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    
    <div id="status" class="status-box">ğŸ‘‹ è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</div>

    <button id="scanBtn" class="btn btn-scan">ğŸ“¡ ç‚¹å‡»å¼€å§‹ NFC æ‰«æ</button>

    <button id="goBtn" class="btn btn-go" onclick="jumpToForm()">
        âœ… éªŒè¯é€šè¿‡<br>
        <span style="font-size:0.9em; font-weight:normal">ç‚¹å‡»è¿›å…¥å¡«å†™è¡¨å•</span>
    </button>
    
    <div id="debug-url"></div>

    <button onclick="closeWindow()" class="btn btn-exit">é€€å‡ºç³»ç»Ÿ</button>
</div>

<script>
    // ==========================================
    // 1. é“¾æ¥é…ç½® (é˜²é”™æ‹†åˆ†ç‰ˆ)
    // ==========================================
    // å°†é“¾æ¥æ‹†å¼€å†™ï¼Œé¿å…å¤åˆ¶æ—¶äº§ç”Ÿéšå½¢ç©ºæ ¼
    const URL_BASE = "https://doc.weixin.qq.com/smartsheet/form/";
    
    // è¯·ç¡®ä¿ä¸‹é¢è¿™ä¸ª ID æ²¡æœ‰ä»»ä½•ç©ºæ ¼ã€‚å¦‚æœä¸ç¡®å®šï¼Œè¯·åªä¿®æ”¹å¼•å·é‡Œçš„å†…å®¹ã€‚
    // æ‚¨çš„åŸå§‹é“¾æ¥ ID: 1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3
    const FORM_ID = "1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3";

    // è‡ªåŠ¨ç»„åˆå¹¶æ¸…ç†ï¼ˆå¼ºåŠ›å»ç©ºæ ¼ï¼‰
    const FINAL_URL = (URL_BASE + FORM_ID).replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '').trim();

    // ==========================================
    // 2. å®éªŒå®¤æ•°æ®åº“
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 3. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const scanBtn = document.getElementById('scanBtn');
    const goBtn = document.getElementById('goBtn');
    const debugDiv = document.getElementById('debug-url');

    window.onload = function() {
        // 1. æ£€æŸ¥URLå‚æ•° (æ¨¡æ‹Ÿè°ƒè¯•ç”¨)
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');
        if (urlLabId) verifyAndShowButton(urlLabId);
        
        // 2. æ£€æŸ¥ç¯å¢ƒ
        if (!("NDEFReader" in window)) {
            console.log("NFC not supported");
        }
    };

    // éªŒè¯é€»è¾‘
    function verifyAndShowButton(id) {
        // æ¸…ç† ID ä¸­çš„æ½œåœ¨ç©ºæ ¼
        id = id.trim();
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆæ ‡ç­¾ ID: ${id}`, "status-error");
            return;
        }

        // éªŒè¯æˆåŠŸ
        updateStatus(
            `âœ… å·²è¯†åˆ«ï¼š${labData.name}<br>` + 
            `<span style="font-weight:normal; font-size:0.9em; color:#137333">å®‰å…¨å‘˜ï¼š${labData.officer}</span>`, 
            "status-success"
        );
        
        // ç•Œé¢åˆ‡æ¢
        scanBtn.style.display = "none";
        goBtn.style.display = "block";
        
        // åœ¨å±å¹•ä¸Šæ˜¾ç¤ºç”Ÿæˆçš„é“¾æ¥ï¼Œæ–¹ä¾¿æ’æŸ¥ (å¦‚ä¸éœ€æ˜¾ç¤ºå¯åˆ é™¤ä¸‹é¢è¿™è¡Œ)
        // debugDiv.style.display = "block";
        // debugDiv.innerText = "ç›®æ ‡é“¾æ¥: " + FINAL_URL;
    }

    // è·³è½¬é€»è¾‘ (æ›¿æ¢å†å²è®°å½•ï¼Œå®ç°"ä¼ªé€€å‡º")
    function jumpToForm() {
        if (!FINAL_URL) {
            alert("é“¾æ¥ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç é…ç½®");
            return;
        }
        // ä½¿ç”¨ replaceï¼Œè¿™æ ·ç”¨æˆ·åœ¨è¡¨å•é¡µç‚¹è¿”å›æ—¶ï¼Œä¸ä¼šå›åˆ°è¿™é‡Œï¼Œè€Œæ˜¯ç›´æ¥é€€å‡º
        window.location.replace(FINAL_URL);
    }

    // é€€å‡ºé€»è¾‘
    function closeWindow() {
        // å¾®ä¿¡/ä¼å¾®ä¸“ç”¨å…³é—­å‘½ä»¤
        if (typeof WeixinJSBridge !== "undefined") {
            WeixinJSBridge.call('closeWindow');
        } else {
            // æ™®é€šæµè§ˆå™¨å…³é—­
            window.opener = null;
            window.open('', '_self');
            window.close();
            updateStatus("å·²å°è¯•å…³é—­ï¼Œå¦‚æœªç”Ÿæ•ˆè¯·æ‰‹åŠ¨å…³é—­", "");
        }
    }

    // NFC æ‰«æé€»è¾‘
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("ğŸ“² è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...");
            
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    
                    // è§£æ ID
                    let scannedId = "";
                    if (text.includes("lab_id=")) {
                        scannedId = text.split("lab_id=")[1].split("&")[0];
                    } else if (record.recordType === "text" && !text.includes("http")) {
                        scannedId = text;
                    }

                    if (scannedId) verifyAndShowButton(scannedId);
                }
            };
        } catch (error) {
            console.error(error);
            updateStatus("âŒ NFC å¯åŠ¨å¤±è´¥<br><small>è¯·ç¡®ä¿ä½¿ç”¨ HTTPS æˆ–å·²å¼€å¯ NFC</small>", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
