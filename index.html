<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥è·³è½¬</title>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 25px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; }
        .status-success { background-color: #e6f4ea; color: #137333; }
        .status-error { background-color: #fce8e6; color: #c5221f; }
        .btn { background-color: #1a73e8; color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; margin-top: 20px; font-size: 16px; display: none; }
        .loading { color: #1a73e8; margin-top: 10px; font-size: 0.9em; display:none;}
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>
    <div id="jumpMsg" class="loading">æ­£åœ¨è·³è½¬è‡³æ£€æŸ¥è¡¨å•...</div>
    <button id="scanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. æ ¸å¿ƒé€»è¾‘ (å·²ä¿®å¤è·³è½¬é—®é¢˜)
    // ==========================================
    const statusDiv = document.getElementById('status');
    const jumpMsg = document.getElementById('jumpMsg');
    const scanBtn = document.getElementById('scanBtn');

    // âš ï¸ æ‚¨çš„ç›®æ ‡é“¾æ¥ (å°½é‡ä¸è¦æ‰‹åŠ¨ä¿®æ”¹è¿™é‡Œï¼Œé˜²æ­¢è¯¯åˆ å­—ç¬¦)
    const TARGET_URL = "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3";

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            verifyAndJump(urlLabId);
        } else {
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰«æ");
                scanBtn.style.display = "block";
            } else {
                updateStatus("âš ï¸ æœªæ£€æµ‹åˆ°NFCå‚æ•°ï¼Œè¯·è´´è¿‘æ ‡ç­¾ã€‚", "status-error");
            }
        }
    };

    function verifyAndJump(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆçš„å®éªŒå®¤ ID (${id})`, "status-error");
            return;
        }

        // éªŒè¯é€šè¿‡
        updateStatus(`âœ… éªŒè¯é€šè¿‡ï¼š${labData.name}`, "status-success");
        scanBtn.style.display = "none";
        jumpMsg.style.display = "block";

        // ============================================
        // æ ¸å¿ƒä¿®å¤ï¼šæš´åŠ›æ¸…æ´— URL å¹¶ä½¿ç”¨ replace è·³è½¬
        // ============================================
        try {
            // 1. å¼ºåˆ¶å»é™¤æ‰€æœ‰ç©ºæ ¼ã€æ¢è¡Œç¬¦ã€ä¸å¯è§å­—ç¬¦
            // è¿™ä¸€æ­¥èƒ½è§£å†³ doctype=undefined çš„é—®é¢˜
            let cleanUrl = TARGET_URL.replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');

            console.log("æ­£åœ¨è·³è½¬åˆ° (æ¸…æ´—å):", cleanUrl);

            setTimeout(() => {
                // 2. ä½¿ç”¨ replace è€Œä¸æ˜¯ hrefï¼Œä¸ä»…æ›´ç¨³ï¼Œè¿˜æ²¡å†å²è®°å½•è´Ÿæ‹…
                window.location.replace(cleanUrl);
            }, 1000);

        } catch (e) {
            updateStatus("é“¾æ¥è·³è½¬å¤±è´¥", "status-error");
            console.error(e);
        }
    }

    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·è´´è¿‘ NFC æ ‡ç­¾...");
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    if (text.includes("lab_id=")) {
                        verifyAndJump(text.split("lab_id=")[1].split("&")[0]);
                        return;
                    } else if (record.recordType === "text" && !text.includes("http")) {
                         verifyAndJump(text);
                         return;
                    }
                }
            };
        } catch (error) {
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
