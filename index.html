<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥</title>
    <style>
        body { font-family: -apple-system, Helvetica, sans-serif; text-align: center; padding: 20px; background-color: #f2f4f7; }
        .container { background: white; padding: 30px 20px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); max-width: 400px; margin: 0 auto; }
        
        /* çŠ¶æ€æ¡†æ ·å¼ */
        .status-box { padding: 15px; border-radius: 10px; background-color: #e9ecef; margin-top: 20px; font-weight: bold; color: #555; word-break: break-all; }
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
        
        /* æŒ‰é’®é€šç”¨æ ·å¼ */
        .btn { border: none; padding: 16px; border-radius: 12px; width: 100%; margin-top: 25px; font-size: 17px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:active { opacity: 0.8; }
        
        /* è“è‰²æ‰«ææŒ‰é’® */
        .btn-scan { background-color: #1a73e8; color: white; }
        
        /* ç»¿è‰²è·³è½¬æŒ‰é’® */
        .btn-go { background-color: #059669; color: white; display: none; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
        
        /* é“¾æ¥å»é™¤ä¸‹åˆ’çº¿ */
        a { text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®‰å…¨å·¡æ£€éªŒè¯</h2>
    
    <div id="status" class="status-box">ğŸ‘‹ è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹</div>

    <button id="scanBtn" class="btn btn-scan">ğŸ“¡ ç‚¹å‡»å¼€å§‹ NFC æ‰«æ</button>

    <a id="finalLink" href="#" target="_self">
        <button id="goBtn" class="btn btn-go">âœ… éªŒè¯é€šè¿‡<br><span style="font-size:0.9em; font-weight:normal">ç‚¹å‡»å¡«å†™æ£€æŸ¥è¡¨</span></button>
    </a>
</div>

<script>
    // ==========================================
    // 1. å®éªŒå®¤æ•°æ®åº“
    // ==========================================
    const LAB_DATABASE = [
        { id: "lab_1", name: "åŸºç¡€æ¥¼1001", officer: "ç‹æ˜‡" },
        { id: "lab_2", name: "åŸºç¡€æ¥¼1002", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_3", name: "åŸºç¡€æ¥¼1004", officer: "å¸¸æ°¸ç”Ÿ" },
        { id: "lab_4", name: "åŸºç¡€æ¥¼1005", officer: "å­™å‡¤ä»™" },
        { id: "lab_5", name: "åŸºç¡€æ¥¼1006", officer: "èµµç¯ç¯" }
    ];

    // ==========================================
    // 2. ç›®æ ‡é“¾æ¥é…ç½®
    // ==========================================
    // å³ä½¿è¿™é‡Œä¸å°å¿ƒæœ‰ç©ºæ ¼ï¼Œä¸‹é¢çš„ä»£ç ä¹Ÿä¼šè‡ªåŠ¨æ¸…ç†
    const RAW_URL = "https://doc.weixin.qq.com/smartsheet/form/1_wpkV4SDgAAcl3du5JJI0jcTfUAhk18fQ_a151f3";

    // ==========================================
    // 3. æ ¸å¿ƒé€»è¾‘
    // ==========================================
    const statusDiv = document.getElementById('status');
    const scanBtn = document.getElementById('scanBtn');
    const goBtn = document.getElementById('goBtn');
    const finalLink = document.getElementById('finalLink');

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        // å¦‚æœ URL é‡Œè‡ªå¸¦ lab_id (æ¨¡æ‹Ÿæµ‹è¯•ç”¨)ï¼Œç›´æ¥éªŒè¯
        if (urlLabId) {
            verifyAndShowButton(urlLabId);
        }
        
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒ NFC
        if (!("NDEFReader" in window)) {
            // æ³¨æ„ï¼šåœ¨ç”µè„‘ä¸Šæ˜¾ç¤ºè¿™ä¸ªé”™è¯¯æ˜¯æ­£å¸¸çš„ï¼Œæ‰‹æœºä¸Šå¦‚æœåœ¨ http åè®®ä¸‹ä¹Ÿä¼šæ˜¾ç¤º
            console.log("NFC not supported or not secure context");
        }
    };

    function verifyAndShowButton(id) {
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ æ— æ•ˆçš„å®éªŒå®¤ ID: ${id}`, "status-error");
            return;
        }

        // --- éªŒè¯æˆåŠŸé€»è¾‘ ---
        
        // 1. æ›´æ–°æç¤ºæ–‡æ¡ˆ
        updateStatus(`âœ… å·²è¯†åˆ«ï¼š${labData.name}<br><span style="font-weight:normal; font-size:0.9em; color:#137333">å®‰å…¨å‘˜ï¼š${labData.officer}</span>`, "status-success");
        
        // 2. éšè—æ‰«ææŒ‰é’®ï¼Œæ˜¾ç¤ºè·³è½¬æŒ‰é’®
        scanBtn.style.display = "none";
        goBtn.style.display = "block";

        // 3. æ„å»ºå¹¶æ¸…æ´—é“¾æ¥ (ç¡®ä¿æ— éšå½¢å­—ç¬¦)
        // è¿™ä¸€æ­¥æ˜¯é˜²æ­¢â€œæ–‡ä»¶ä¸å­˜åœ¨â€çš„å…³é”®
        const cleanUrl = RAW_URL.replace(/\s+/g, '').replace(/[\u200B-\u200D\uFEFF]/g, '');
        
        // 4. å°†æ¸…æ´—åçš„é“¾æ¥èµ‹ç»™ A æ ‡ç­¾
        finalLink.href = cleanUrl;
        
        console.log("é“¾æ¥å·²å°±ç»ª:", cleanUrl);
    }

    // NFC æ‰«æç›‘å¬
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("ğŸ“² è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...");
            
            ndef.onreading = event => {
                const decoder = new TextDecoder();
                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    
                    // è§£æé€»è¾‘ï¼šæ”¯æŒ "lab_id=xxx" æ ¼å¼æˆ–çº¯æ–‡æœ¬æ ¼å¼
                    if (text.includes("lab_id=")) {
                        verifyAndShowButton(text.split("lab_id=")[1].split("&")[0]);
                    } else if (record.recordType === "text" && !text.includes("http")) {
                        verifyAndShowButton(text);
                    }
                }
            };
        } catch (error) {
            console.error(error);
            updateStatus("âŒ æ‰«æå¯åŠ¨å¤±è´¥ (è¯·ç¡®ä¿å·²å¼€å¯NFCæƒé™)", "status-error");
        }
    });

    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>
</body>
</html>
