<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒå®¤å®‰å…¨æ£€æŸ¥ - èº«ä»½éªŒè¯</title>
    <style>
        /* å…¨å±€æ ·å¼è®¾ç½® */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .container {
            background: white;
            padding: 25px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 400px;
            margin: 0 auto;
        }

        h2 { margin-bottom: 10px; color: #1a73e8; }

        /* é¡¶éƒ¨æ¨¡å¼æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e8f0fe;
            color: #1a73e8;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* å®éªŒå®¤ä¿¡æ¯å¡ç‰‡ */
        .info-card {
            background: #f8f9fa;
            border-left: 4px solid #1a73e8;
            padding: 15px;
            text-align: left;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none; /* é»˜è®¤éšè—ï¼ŒéªŒè¯é€šè¿‡åæ˜¾ç¤º */
        }
        .info-card p { margin: 8px 0; font-size: 1rem; }

        /* çŠ¶æ€æç¤ºæ¡† */
        .status-box {
            padding: 15px;
            border-radius: 8px;
            background-color: #e9ecef;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #555;
            margin-bottom: 20px;
            flex-direction: column;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 14px 20px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 500;
            display: none; /* é»˜è®¤éšè— */
        }
        .btn:active { transform: scale(0.98); }
        
        /* çŠ¶æ€é¢œè‰²å®šä¹‰ */
        .status-success { background-color: #e6f4ea; color: #137333; border: 1px solid #ceead6; }
        .status-error { background-color: #fce8e6; color: #c5221f; border: 1px solid #fad2cf; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ›¡ï¸ å®éªŒå®¤å®‰å…¨å«å£«</h2>
    
    <div id="modeBadge" class="badge">æ£€æµ‹ä¸­...</div>

    <div id="labInfoCard" class="info-card">
        <p><strong>ğŸ“ å®éªŒå®¤ï¼š</strong> <span id="labName">--</span></p>
        <p><strong>ğŸ‘¤ å®‰å…¨å‘˜ï¼š</strong> <span id="labOfficer">--</span></p>
    </div>

    <div id="status" class="status-box">å‡†å¤‡å°±ç»ª</div>

    <button id="androidScanBtn" class="btn">ğŸ“¡ å¼€å¯ NFC æ‰«æ</button>
</div>

<script>
    // ==========================================
    // 1. æ•°æ®åº“é…ç½® (å·²ç§»é™¤ç»çº¬åº¦)
    // ==========================================
    const LAB_DATABASE = [
        {
            id: "test1",           
            name: "æµ‹è¯•æˆ¿é—´",       
            officer: "æµ‹è¯•äºº1"
        },
        // å¯åœ¨æ­¤æ·»åŠ æ›´å¤šå®éªŒå®¤...
        {
            id: "chem_01",
            name: "ç¬¬ä¸€åŒ–å­¦å®éªŒå®¤",
            officer: "ç‹è€å¸ˆ"
        }
    ];

    // ==========================================
    // 2. è·å–é¡µé¢å…ƒç´ 
    // ==========================================
    const statusDiv = document.getElementById('status');
    const labInfoCard = document.getElementById('labInfoCard');
    const scanBtn = document.getElementById('androidScanBtn');
    const modeBadge = document.getElementById('modeBadge');

    // ==========================================
    // 3. é¡µé¢å…¥å£é€»è¾‘
    // ==========================================
    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlLabId = urlParams.get('lab_id');

        if (urlLabId) {
            // [æ¨¡å¼ A] é€šè¿‡ URL å‚æ•°è¿›å…¥ (iOS/Androidé€šç”¨)
            modeBadge.innerText = "æ¨¡å¼ï¼šNFC è‡ªåŠ¨è¯†åˆ«";
            verifyLab(urlLabId);
        } else {
            // [æ¨¡å¼ B] æ‰‹åŠ¨æ‰“å¼€ç½‘é¡µ
            modeBadge.innerText = "æ¨¡å¼ï¼šæ‰‹åŠ¨æ‰«æ";
            
            if ("NDEFReader" in window) {
                updateStatus("è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œæ‰«æ");
                scanBtn.style.display = "block";
            } else {
                updateStatus("æœªæ£€æµ‹åˆ°æ ‡ç­¾ä¿¡æ¯ï¼Œä¸”æµè§ˆå™¨ä¸æ”¯æŒæ‰«æã€‚<br>è¯·ç›´æ¥ç”¨æ‰‹æœºè´´è¿‘å¢™ä¸Šçš„ NFC æ ‡ç­¾ã€‚", "status-error");
            }
        }
    };

    // ==========================================
    // 4. éªŒè¯é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹ï¼šå»æ‰ä½ç½®æ ¡éªŒï¼Œç›´æ¥é€šè¿‡)
    // ==========================================
    function verifyLab(id) {
        // æŸ¥æ‰¾æ•°æ®åº“
        const labData = LAB_DATABASE.find(item => item.id === id);

        if (!labData) {
            updateStatus(`âŒ éªŒè¯å¤±è´¥ï¼šæ— æ•ˆçš„å®éªŒå®¤æ ‡ç­¾`, "status-error");
            return;
        }

        // --- éªŒè¯é€šè¿‡ ---
        
        // 1. å¡«å……ä¿¡æ¯ (ä¸æ˜¾ç¤º ID)
        document.getElementById('labName').innerText = labData.name;
        document.getElementById('labOfficer').innerText = labData.officer;
        
        // 2. æ˜¾ç¤ºä¿¡æ¯å¡ç‰‡
        labInfoCard.style.display = "block";
        scanBtn.style.display = "none";

        // 3. æ›´æ–°çŠ¶æ€æç¤º
        updateStatus("âœ… éªŒè¯é€šè¿‡ï¼Œè¯·è¿›è¡Œå®éªŒå®¤å®‰å…¨æ£€æŸ¥", "status-success");

        // 4. (å¯é€‰) å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªåŠ¨è·³è½¬é€»è¾‘
        // setTimeout(() => { window.location.href = "check_form.html"; }, 1500);
    }

    // ==========================================
    // 5. Android æ‰‹åŠ¨æ‰«æé€»è¾‘
    // ==========================================
    scanBtn.addEventListener("click", async () => {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            updateStatus("è¯·å°†æ‰‹æœºè´´è¿‘ NFC æ ‡ç­¾...");

            ndef.onreading = event => {
                const decoder = new TextDecoder();
                let scannedId = null;

                for (const record of event.message.records) {
                    const text = decoder.decode(record.data);
                    
                    // è§£æ URL ä¸­çš„ id æˆ– çº¯æ–‡æœ¬ id
                    if (text.includes("lab_id=")) {
                        scannedId = text.split("lab_id=")[1].split("&")[0];
                        break;
                    } else if (record.recordType === "text" && !text.includes("http")) {
                        scannedId = text;
                        break;
                    }
                }

                if (scannedId) {
                    verifyLab(scannedId);
                } else {
                    updateStatus("æœªèƒ½è¯†åˆ«æœ‰æ•ˆçš„æ ‡ç­¾æ•°æ®", "status-error");
                }
            };
        } catch (error) {
            updateStatus("æ‰«æå¯åŠ¨å¤±è´¥: " + error.message, "status-error");
        }
    });

    // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°çŠ¶æ€æ 
    function updateStatus(html, className = "") {
        statusDiv.innerHTML = html;
        statusDiv.className = "status-box " + className;
    }
</script>

</body>
</html>
